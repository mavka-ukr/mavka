взяти означення ./мавка;

структура Шлях {
  розмір: природне;
  дані: памʼять<п8>;
}

структура ВихідФайлу {
  розмір: природне;
  дані: памʼять<п8>;
}

зовнішня дія __вивести_ю8(значення: адреса<ю8>) -> ніщо;
зовнішня дія __вивести_д64(значення: д64) -> ніщо;
зовнішня дія __надрукувати_ю8(значення: адреса<ю8>) -> ніщо;
зовнішня дія __надрукувати_д64(значення: д64) -> ніщо;
зовнішня дія __виділити_сиру_памʼять(розмір: природне) -> памʼять<п8>;
зовнішня дія __перевиділити_сиру_памʼять(значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8>;
зовнішня дія __звільнити_сиру_памʼять(значення: памʼять<п8>) -> ніщо;
зовнішня дія __вийти(код: ц32) -> ніщо;
зовнішня дія __прочитати_файл(шлях: адреса<Шлях>, вихід_файлу: адреса<ВихідФайлу>) -> логічне;

дія вивести_ю8(значення: ю8) {
  __вивести_ю8(значення::адреса);
}

дія вивести_д64(значення: д64) {
  __вивести_д64(значення);
}

дія надрукувати_ю8(значення: ю8) {
  __надрукувати_ю8(значення::адреса);
}

дія надрукувати_д64(значення: д64) {
  __надрукувати_д64(значення);
}

дія виділити_сиру_памʼять(М: адреса<мавка::Машина>, розмір: природне) -> памʼять<п8> {
  вернути __виділити_сиру_памʼять(розмір);
}

дія перевиділити_сиру_памʼять(М: адреса<мавка::Машина>, значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8> {
  вернути __перевиділити_сиру_памʼять(значення, новий_розмір);
}

дія звільнити_сиру_памʼять(М: адреса<мавка::Машина>, значення: памʼять<п8>) {
  __звільнити_сиру_памʼять(значення);
}

дія КД_виділити_сиру_памʼять(система: адреса<КД::Система>, розмір: природне) -> памʼять<п8> {
  вернути __виділити_сиру_памʼять(розмір);
}

дія КД_перевиділити_сиру_памʼять(система: адреса<КД::Система>, значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8> {
  вернути __перевиділити_сиру_памʼять(значення, новий_розмір);
}

дія КД_звільнити_сиру_памʼять(система: адреса<КД::Система>, значення: невідома_памʼять) {
  __звільнити_сиру_памʼять(значення як памʼять<п8>);
}

дія вивести(М: адреса<мавка::Машина>, текст: кд) {
  змінна система_КД = КД::Система {
    дані = М,
    виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
    звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
    перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
  };

  змінна значення_ю8: ю8;
  
  якщо КД::перекодувати_в_ю8(система_КД::адреса, текст, ні, значення_ю8::адреса, пусто) {
    вивести_ю8(значення_ю8);

    мавка::звільнити_памʼять(М, значення_ю8.дані);
  } інакше {
    надрукувати_ю8(ю8"Помилка виводу тексту");
  }
}

дія надрукувати(М: адреса<мавка::Машина>, текст: кд) {
  змінна система_КД = КД::Система {
    дані = М,
    виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
    звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
    перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
  };

  змінна значення_ю8: ю8;
  
  якщо КД::перекодувати_в_ю8(система_КД::адреса, текст, ні, значення_ю8::адреса, пусто) {
    надрукувати_ю8(значення_ю8);

    мавка::звільнити_памʼять(М, значення_ю8.дані);
  } інакше {
    надрукувати_ю8(ю8"Помилка друку тексту");
  }
}

дія запанікувати(М: адреса<мавка::Машина>, повідомлення: кд) {
  надрукувати(М, повідомлення);

  __вийти(1);
}

дія надрукувати_значення(М: адреса<мавка::Машина>, значення: адреса<мавка::Дійсне>) {
  якщо значення == пусто {
    надрукувати_ю8(ю8"недійсне");
  } інакше якщо значення.тип == М.значення_структура_Число {
    змінна предмет_числа = значення як адреса<мавка::Предмет>;
    змінна властивості_числа = предмет_числа.властивості як мавка::ВластивостіЧисла;

    надрукувати_д64(властивості_числа.значення);
  } інакше {
    надрукувати_ю8(ю8"невідомо");
  }
}

дія рідна_дія_друк(М: адреса<мавка::Машина>,
                   здійснювач: адреса<мавка::Дійсне>,
                   значення: адреса<мавка::Дійсне>,
                   кількість_задіяних: природне, 
                   задіяні: памʼять<адреса<мавка::Дійсне>>,
                   іменовано_задіяні: адреса<мавка::ІменованіЗадіяні>) -> адреса<мавка::Дійсне> {
  змінна п: природне = 0;
  поки п < кількість_задіяних {
    надрукувати_значення(М, задіяні[п]);
  
    п += 1;
  }
  
  вернути пусто;                  
}

дія дія_виводу(М: адреса<мавка::Машина>, текст: кд) {
  вивести(М, текст);
}

зовнішня дія старт() -> ц32 {
  змінна вихід_файлу: ВихідФайлу;
  змінна шлях_до_файлу = ю8"привіт.м";
  змінна шлях = шлях_до_файлу::адреса як адреса<Шлях>;
  якщо не __прочитати_файл(шлях, вихід_файлу::адреса) {
    надрукувати_ю8(ю8"Не вдалося прочитати файл привіт.м");
    вернути 1;
  }

  змінна система_КД = КД::Система {
    дані = пусто,
    виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
    звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
    перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
  };

  змінна сирий_текст: кд;
  якщо не КД::перекодувати_з_ю8(система_КД::адреса, ю8 { вихід_файлу.розмір, вихід_файлу.дані }, ні, ні, сирий_текст::адреса, пусто) {
    надрукувати_ю8(ю8"Помилка перекодування файлу привіт.м в кд");
    вернути 1;
  }

  змінна М = мавка::створити_машину(мавка::Налаштування {
    виділити_сиру_памʼять = виділити_сиру_памʼять,
    перевиділити_сиру_памʼять = перевиділити_сиру_памʼять,
    звільнити_сиру_памʼять = звільнити_сиру_памʼять,
    запанікувати = запанікувати
  });

  // змінна а = мавка::створити_число(М, 2);
  // змінна б = мавка::створити_число(М, 2);

  // змінна в = мавка::виконати_додавання(М, а, б);
  
  // надрукувати_значення(М, в);
  
  змінна дія_друк = мавка::створити_рідну_дію(
    М,
    мавка::створити_текст(М, "друк"),
    пусто,
    рідна_дія_друк
  );

  мавка::визначити_в_дійсності(
    М,
    М.глобальна_дійсність,
    мавка::створити_текст(М, "друк"),
    дія_друк
  );
  
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);

  // надрукувати_д64(д64(М.накопичувач_значень.розмір));

  // змінна результат = мавка::здійснити(
  //   М,
  //   пусто,
  //   дія_друк,
  //   0,
  //   пусто,
  //   пусто
  // );

  // змінна розмір_вказівок: природне = 2;
  // змінна дані_вказівок = мавка::виділити_памʼять<п8>(М, розмір_вказівок);
  // дані_вказівок[0] = мавка::ВДодати;
  // дані_вказівок[1] = мавка::ВВернути;

  // змінна вказівки = мавка::створити_дані(
  //   М,
  //   розмір_вказівок,
  //   дані_вказівок
  // );

  // мавка::звільнити_памʼять(М, дані_вказівок);

  // змінна код = мавка::створити_код(
  //   М,
  //   пусто,
  //   вказівки
  // );

  // змінна дія_сума = мавка::створити_дію(
  //   М,
  //   пусто,
  //   мавка::створити_текст(М, "сума"),
  //   пусто,
  //   код
  // );
  
  // мавка::покласти_в_накопичувач_значень(М, мавка::створити_число(М, 12));
  // мавка::покласти_в_накопичувач_значень(М, мавка::створити_число(М, 23));

  // результат = мавка::здійснити(
  //   М,
  //   пусто,
  //   дія_сума,
  //   0,
  //   пусто,
  //   пусто
  // );

  // надрукувати_значення(М, результат);
  
  змінна слова: мавка::розбирач::Слова;
  змінна помилка_розбору_на_слова: мавка::розбирач::ПомилкаРозборуНаСлова;
  
  змінна успіх = мавка::розбирач::розібрати_на_слова(
    М, 
    сирий_текст, 
    слова::адреса, 
    помилка_розбору_на_слова::адреса
  );
  якщо не успіх {
    надрукувати_ю8(ю8"Помилка розбору на слова");
    вернути 1;
  }

  змінна сполуки: мавка::розбирач::Сполуки;
  змінна помилка_розбору_на_сполуки: мавка::розбирач::ПомилкаРозборуНаСполуки;
  успіх = мавка::розбирач::розібрати_слова_на_сполуки(
    М,
    сирий_текст,
    слова,
    сполуки::адреса,
    помилка_розбору_на_сполуки::адреса
  );
  якщо не успіх {
    надрукувати_ю8(ю8"Помилка розбору на сполуки");
    вернути 1;
  }

  змінна перекладений_код: мавка::Значення = пусто;
  змінна помилка_перекладу: мавка::перекладач::ПомилкаПерекладу;

  змінна успіх_перекладу = мавка::перекласти_в_код(
    М,
    сирий_текст,
    слова,
    сполуки,
    перекладений_код::адреса,
    помилка_перекладу::адреса
  );
  якщо не успіх_перекладу {
    надрукувати(М, "Помилка перекладу: ");
    надрукувати(М, помилка_перекладу.повідомлення);
    вернути 1;
  }
  
  змінна предмет_коду = перекладений_код як адреса<мавка::Предмет>;
  змінна властивості_коду = предмет_коду.властивості як мавка::ВластивостіКоду;
  змінна дані_коду = властивості_коду.вказівки як адреса<мавка::Предмет>;
  змінна властивості_даних_коду = дані_коду.властивості як мавка::ВластивостіДаних;
  мавка::надрукувати_код(М, властивості_даних_коду.розмір, властивості_даних_коду.дані, дія_виводу);

  змінна д = мавка::створити_дію(
    М,
    М.глобальна_дійсність,
    пусто,
    пусто,
    перекладений_код
  );

  змінна результат = мавка::здійснити(
    М,
    пусто,
    д,
    0,
    пусто,
    пусто
  );

  вернути 0;
}