взяти означення ./мавка;

зовнішня дія __надрукувати_ю8(значення: адреса<ю8>) -> ніщо;
зовнішня дія __надрукувати_д64(значення: д64) -> ніщо;
зовнішня дія __виділити_сиру_памʼять(розмір: природне) -> памʼять<п8>;
зовнішня дія __перевиділити_сиру_памʼять(значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8>;
зовнішня дія __звільнити_сиру_памʼять(значення: памʼять<п8>) -> ніщо;
зовнішня дія __вийти(код: ц32) -> ніщо;

дія надрукувати_ю8(значення: ю8) {
  __надрукувати_ю8(значення::адреса);
}

дія надрукувати_д64(значення: д64) {
  __надрукувати_д64(значення);
}

дія виділити_сиру_памʼять(М: адреса<мавка::Машина>, розмір: природне) -> памʼять<п8> {
  вернути __виділити_сиру_памʼять(розмір);
}

дія перевиділити_сиру_памʼять(М: адреса<мавка::Машина>, значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8> {
  вернути __перевиділити_сиру_памʼять(значення, новий_розмір);
}

дія звільнити_сиру_памʼять(М: адреса<мавка::Машина>, значення: памʼять<п8>) {
  __звільнити_сиру_памʼять(значення);
}

дія КД_виділити_сиру_памʼять(система: адреса<КД::Система>, розмір: природне) -> памʼять<п8> {
  вернути __виділити_сиру_памʼять(розмір);
}

дія КД_перевиділити_сиру_памʼять(система: адреса<КД::Система>, значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8> {
  вернути __перевиділити_сиру_памʼять(значення, новий_розмір);
}

дія КД_звільнити_сиру_памʼять(система: адреса<КД::Система>, значення: невідома_памʼять) {
  __звільнити_сиру_памʼять(значення як памʼять<п8>);
}

дія запанікувати(М: адреса<мавка::Машина>, повідомлення: кд) {
  змінна система_КД = КД::Система {
    дані = М,
    виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
    звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
    перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
  };

  змінна значення_ю8: ю8;
  
  якщо не КД::перекодувати_в_ю8(система_КД::адреса, повідомлення, ні, значення_ю8::адреса, пусто) {
    надрукувати_ю8(ю8"Айайайай!!!");
  
    __вийти(1);
  }

  надрукувати_ю8(значення_ю8);

  __вийти(1);
}

дія надрукувати_значення(М: адреса<мавка::Машина>, значення: адреса<мавка::Дійсне>) {
  якщо значення.тип == М.значення_структура_Число {
    змінна предмет_числа = значення як адреса<мавка::Предмет>;
    змінна властивості_числа = предмет_числа.властивості як мавка::ВластивостіЧисла;

    надрукувати_д64(властивості_числа.значення);
  } інакше {
    надрукувати_ю8(ю8"невідомо");
  }
}

дія рідна_дія_друк(М: адреса<мавка::Машина>,
                   здійснювач: адреса<мавка::Дійсне>,
                   значення: адреса<мавка::Дійсне>,
                   кількість_задіяних: природне, 
                   задіяні: памʼять<адреса<мавка::Дійсне>>,
                   іменовано_задіяні: адреса<мавка::ІменованіЗадіяні>) -> адреса<мавка::Дійсне> {
  надрукувати_ю8(ю8"привіт");
  вернути пусто;                  
}

зовнішня дія старт() -> ц32 {
  змінна сирий_текст = "друк(2 + 2)";

  змінна М = виділити_сиру_памʼять(пусто, мавка::Машина.розмір) як адреса<мавка::Машина>;
  
  мавка::налаштувати_машину(М, мавка::Налаштування {
    виділити_сиру_памʼять = виділити_сиру_памʼять,
    перевиділити_сиру_памʼять = перевиділити_сиру_памʼять,
    звільнити_сиру_памʼять = звільнити_сиру_памʼять,
    запанікувати = запанікувати
  });

  // змінна а = мавка::створити_число(М, 2);
  // змінна б = мавка::створити_число(М, 2);

  // змінна в = мавка::виконати_додавання(М, а, б);
  
  // надрукувати_значення(М, в);
  
  // змінна дія_друк = мавка::створити_рідну_дію(
  //   М,
  //   мавка::створити_текст(М, "друк"),
  //   пусто,
  //   рідна_дія_друк
  // );
  
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);
  // мавка::покласти_в_накопичувач_значень(М, пусто);

  // надрукувати_д64(д64(М.накопичувач_значень.розмір));

  // змінна результат = мавка::здійснити(
  //   М,
  //   пусто,
  //   дія_друк,
  //   0,
  //   пусто,
  //   пусто
  // );

  // змінна розмір_вказівок: природне = 2;
  // змінна дані_вказівок = мавка::виділити_памʼять<п8>(М, розмір_вказівок);
  // дані_вказівок[0] = мавка::ВДодати;
  // дані_вказівок[1] = мавка::ВВернути;

  // змінна вказівки = мавка::створити_дані(
  //   М,
  //   розмір_вказівок,
  //   дані_вказівок
  // );

  // мавка::звільнити_памʼять(М, дані_вказівок);

  // змінна код = мавка::створити_код(
  //   М,
  //   пусто,
  //   вказівки
  // );

  // змінна дія_сума = мавка::створити_дію(
  //   М,
  //   пусто,
  //   мавка::створити_текст(М, "сума"),
  //   пусто,
  //   код
  // );
  
  // мавка::покласти_в_накопичувач_значень(М, мавка::створити_число(М, 12));
  // мавка::покласти_в_накопичувач_значень(М, мавка::створити_число(М, 23));

  // результат = мавка::здійснити(
  //   М,
  //   пусто,
  //   дія_сума,
  //   0,
  //   пусто,
  //   пусто
  // );

  // надрукувати_значення(М, результат);
  
  змінна слова: мавка::розбирач::Слова;
  змінна помилка_розбору_на_слова: мавка::розбирач::ПомилкаРозборуНаСлова;
  
  змінна успіх = мавка::розбирач::розібрати_на_слова(
    М, 
    сирий_текст, 
    слова::адреса, 
    помилка_розбору_на_слова::адреса
  );
  якщо не успіх {
    надрукувати_ю8(ю8"Помилка розбору на слова");
    вернути 1;
  }

  змінна сполуки: мавка::розбирач::Сполуки;
  змінна помилка_розбору_на_сполуки: мавка::розбирач::ПомилкаРозборуНаСполуки;
  успіх = мавка::розбирач::розібрати_слова_на_сполуки(
    М,
    сирий_текст,
    слова,
    сполуки::адреса,
    помилка_розбору_на_сполуки::адреса
  );
  якщо не успіх {
    надрукувати_ю8(ю8"Помилка розбору на сполуки");
    вернути 1;
  }

  змінна перекладений_код: мавка::Значення = пусто;
  змінна помилка_перекладу: мавка::перекладач::ПомилкаПерекладу;

  змінна успіх_перекладу = мавка::перекласти_в_код(
    М,
    сирий_текст,
    слова,
    сполуки,
    перекладений_код::адреса,
    помилка_перекладу::адреса
  );
  якщо не успіх_перекладу {
    надрукувати_ю8(ю8"Помилка перекладу");
    вернути 1;
  }

  змінна д = мавка::створити_дію(
    М,
    пусто,
    пусто,
    пусто,
    перекладений_код
  );

  змінна результат = мавка::здійснити(
    М,
    пусто,
    д,
    0,
    пусто,
    пусто
  );

  вернути 0;
}