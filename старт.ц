взяти означення ./мавка;

структура Шлях {
  розмір: природне;
  дані: памʼять<п8>;
}

структура ВихідФайлу {
  розмір: природне;
  дані: памʼять<п8>;
}

зовнішня дія __вивести_ю8(значення: адреса<ю8>) -> ніщо;
зовнішня дія __вивести_д64(значення: д64) -> ніщо;
зовнішня дія __надрукувати_ю8(значення: адреса<ю8>) -> ніщо;
зовнішня дія __надрукувати_д64(значення: д64) -> ніщо;
зовнішня дія __виділити_сиру_памʼять(розмір: природне) -> памʼять<п8>;
зовнішня дія __перевиділити_сиру_памʼять(значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8>;
зовнішня дія __звільнити_сиру_памʼять(значення: памʼять<п8>) -> ніщо;
зовнішня дія __вийти(код: ц32) -> ніщо;
зовнішня дія __прочитати_файл(шлях: адреса<Шлях>, вихід_файлу: адреса<ВихідФайлу>) -> логічне;
зовнішня дія __перетворити_п64_в_ю8(значення: п64, вихід_ю8: адреса<ю8>) -> логічне;
зовнішня дія __перетворити_ц64_в_ю8(значення: ц64, вихід_ю8: адреса<ю8>) -> логічне;
зовнішня дія __перетворити_д64_в_ю8(значення: д64, вихід_ю8: адреса<ю8>) -> логічне;

дія вивести_ю8(значення: ю8) {
  __вивести_ю8(значення::адреса);
}

дія вивести_д64(значення: д64) {
  __вивести_д64(значення);
}

дія надрукувати_ю8(значення: ю8) {
  __надрукувати_ю8(значення::адреса);
}

дія надрукувати_д64(значення: д64) {
  __надрукувати_д64(значення);
}

дія виділити_сиру_памʼять(М: адреса<мавка::Машина>, розмір: природне) -> памʼять<п8> {
  вернути __виділити_сиру_памʼять(розмір);
}

дія перевиділити_сиру_памʼять(М: адреса<мавка::Машина>, значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8> {
  вернути __перевиділити_сиру_памʼять(значення, новий_розмір);
}

дія звільнити_сиру_памʼять(М: адреса<мавка::Машина>, значення: памʼять<п8>) {
  __звільнити_сиру_памʼять(значення);
}

дія КД_виділити_сиру_памʼять(система: адреса<КД::Система>, розмір: природне) -> памʼять<п8> {
  вернути __виділити_сиру_памʼять(розмір);
}

дія КД_перевиділити_сиру_памʼять(система: адреса<КД::Система>, значення: памʼять<п8>, новий_розмір: природне) -> памʼять<п8> {
  вернути __перевиділити_сиру_памʼять(значення, новий_розмір);
}

дія КД_звільнити_сиру_памʼять(система: адреса<КД::Система>, значення: невідома_памʼять) {
  __звільнити_сиру_памʼять(значення як памʼять<п8>);
}

дія вивести(М: адреса<мавка::Машина>, текст: кд) {
  змінна система_КД = КД::Система {
    дані = М,
    виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
    звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
    перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
  };

  змінна значення_ю8: ю8;
  
  якщо КД::перекодувати_в_ю8(система_КД::адреса, текст, ні, значення_ю8::адреса, пусто) {
    вивести_ю8(значення_ю8);

    мавка::звільнити_памʼять(М, значення_ю8.дані);
  } інакше {
    надрукувати_ю8(ю8"Помилка виводу тексту");
  }
}

дія надрукувати(М: адреса<мавка::Машина>, текст: кд) {
  змінна система_КД = КД::Система {
    дані = М,
    виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
    звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
    перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
  };

  змінна значення_ю8: ю8;
  
  якщо КД::перекодувати_в_ю8(система_КД::адреса, текст, ні, значення_ю8::адреса, пусто) {
    надрукувати_ю8(значення_ю8);

    мавка::звільнити_памʼять(М, значення_ю8.дані);
  } інакше {
    надрукувати_ю8(ю8"Помилка друку тексту");
  }
}

дія запанікувати(М: адреса<мавка::Машина>, повідомлення: кд) {
  надрукувати(М, повідомлення);

  __вийти(1);
}

дія перетворити_п64_в_кд(М: адреса<мавка::Машина>, значення: п64, вихід_текстового_значення: адреса<кд>) -> логічне {
  змінна значення_ю8: ю8;

  якщо __перетворити_п64_в_ю8(значення, значення_ю8::адреса) {
    змінна значення_кд: кд;

    змінна система_КД = КД::Система {
      дані = М,
      виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
      звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
      перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
    };

    якщо КД::перекодувати_з_ю8(система_КД::адреса, значення_ю8, ні, ні, значення_кд::адреса, пусто) {
      вихід_текстового_значення.розмір = значення_кд.розмір;
      вихід_текстового_значення.дані = значення_кд.дані;

      мавка::звільнити_памʼять(М, значення_ю8.дані);

      вернути так;
    }

    мавка::звільнити_памʼять(М, значення_ю8.дані);  
  }

  вернути ні;
}

дія перетворити_ц64_в_кд(М: адреса<мавка::Машина>, значення: ц64, вихід_текстового_значення: адреса<кд>) -> логічне {
  змінна значення_ю8: ю8;

  якщо __перетворити_ц64_в_ю8(значення, значення_ю8::адреса) {
    змінна значення_кд: кд;

    змінна система_КД = КД::Система {
      дані = М,
      виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
      звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
      перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
    };

    якщо КД::перекодувати_з_ю8(система_КД::адреса, значення_ю8, ні, ні, значення_кд::адреса, пусто) {
      вихід_текстового_значення.розмір = значення_кд.розмір;
      вихід_текстового_значення.дані = значення_кд.дані;

      мавка::звільнити_памʼять(М, значення_ю8.дані);

      вернути так;
    }

    мавка::звільнити_памʼять(М, значення_ю8.дані);  
  }

  вернути ні;
}

дія перетворити_д64_в_кд(М: адреса<мавка::Машина>, значення: д64, вихід_текстового_значення: адреса<кд>) -> логічне {
  змінна значення_ю8: ю8;

  якщо __перетворити_д64_в_ю8(значення, значення_ю8::адреса) {
    змінна значення_кд: кд;

    змінна система_КД = КД::Система {
      дані = М,
      виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
      звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
      перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
    };

    якщо КД::перекодувати_з_ю8(система_КД::адреса, значення_ю8, ні, ні, значення_кд::адреса, пусто) {
      вихід_текстового_значення.розмір = значення_кд.розмір;
      вихід_текстового_значення.дані = значення_кд.дані;

      мавка::звільнити_памʼять(М, значення_ю8.дані);

      вернути так;
    }

    мавка::звільнити_памʼять(М, значення_ю8.дані);  
  }

  вернути ні;
}

дія дія_виводу(М: адреса<мавка::Машина>, текст: кд) {
  вивести(М, текст);
}

зовнішня дія старт() -> ц32 {
  змінна вихід_файлу: ВихідФайлу;
  змінна шлях_до_файлу = ю8"привіт.м";
  змінна шлях = шлях_до_файлу::адреса як адреса<Шлях>;
  якщо не __прочитати_файл(шлях, вихід_файлу::адреса) {
    надрукувати_ю8(ю8"Не вдалося прочитати файл привіт.м");
    вернути 1;
  }

  змінна система_КД = КД::Система {
    дані = пусто,
    виділити_сиру_памʼять = КД_виділити_сиру_памʼять,
    звільнити_сиру_памʼять = КД_звільнити_сиру_памʼять,
    перевиділити_сиру_памʼять = КД_перевиділити_сиру_памʼять
  };

  змінна сирий_текст: кд;
  якщо не КД::перекодувати_з_ю8(система_КД::адреса, ю8 { вихід_файлу.розмір, вихід_файлу.дані }, ні, ні, сирий_текст::адреса, пусто) {
    надрукувати_ю8(ю8"Помилка перекодування файлу привіт.м в кд");
    вернути 1;
  }

  змінна М = мавка::створити_машину(мавка::Налаштування {
    виділити_сиру_памʼять = виділити_сиру_памʼять,
    перевиділити_сиру_памʼять = перевиділити_сиру_памʼять,
    звільнити_сиру_памʼять = звільнити_сиру_памʼять,
    запанікувати = запанікувати,
    вивести = вивести,
    перетворити_п64_в_кд = перетворити_п64_в_кд,
    перетворити_ц64_в_кд = перетворити_ц64_в_кд,
    перетворити_д64_в_кд = перетворити_д64_в_кд
  });

  мавка::визначити_глобальні_виводу(М);
  
  змінна слова: мавка::розбирач::Слова;
  змінна помилка_розбору_на_слова: мавка::розбирач::ПомилкаРозборуНаСлова;
  
  змінна успіх = мавка::розбирач::розібрати_на_слова(
    М, 
    сирий_текст, 
    слова::адреса, 
    помилка_розбору_на_слова::адреса
  );
  якщо не успіх {
    надрукувати_ю8(ю8"Помилка розбору на слова");
    вернути 1;
  }

  змінна сполуки: мавка::розбирач::Сполуки;
  змінна помилка_розбору_на_сполуки: мавка::розбирач::ПомилкаРозборуНаСполуки;
  успіх = мавка::розбирач::розібрати_слова_на_сполуки(
    М,
    сирий_текст,
    слова,
    сполуки::адреса,
    помилка_розбору_на_сполуки::адреса
  );
  якщо не успіх {
    надрукувати_ю8(ю8"Помилка розбору на сполуки");
    вернути 1;
  }

  змінна перекладений_код: мавка::Значення = пусто;
  змінна помилка_перекладу: мавка::перекладач::ПомилкаПерекладу;

  змінна успіх_перекладу = мавка::перекласти_в_код(
    М,
    сирий_текст,
    слова,
    сполуки,
    перекладений_код::адреса,
    помилка_перекладу::адреса
  );
  якщо не успіх_перекладу {
    надрукувати(М, "Помилка перекладу: ");
    надрукувати(М, помилка_перекладу.повідомлення);
    вернути 1;
  }
  
  змінна предмет_коду = перекладений_код як адреса<мавка::Предмет>;
  змінна властивості_коду = предмет_коду.властивості як мавка::ВластивостіКоду;
  змінна дані_коду = властивості_коду.вказівки як адреса<мавка::Предмет>;
  змінна властивості_даних_коду = дані_коду.властивості як мавка::ВластивостіДаних;
  мавка::надрукувати_код(М, властивості_даних_коду.розмір, властивості_даних_коду.дані, дія_виводу);

  змінна д = мавка::створити_дію(
    М,
    М.глобальна_дійсність,
    пусто,
    пусто,
    пусто,
    перекладений_код
  );

  змінна результат = мавка::здійснити(
    М,
    пусто,
    д,
    0,
    пусто,
    пусто
  );

  вернути 0;
}