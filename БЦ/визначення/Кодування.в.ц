взяти означення ./Памʼять;
взяти означення ./КД;

простір біб {
  синонім МісцезнаходженняПерекодованого = КД::Місцезнаходження;

  дія система_КД_виділити_сиру_памʼять(система: адреса<КД::Система>,
                                       розмір: природне) -> памʼять<п8> {
    вернути виділити_памʼять<п8>(розмір);
  }

  дія система_КД_перевиділити_сиру_памʼять(система: адреса<КД::Система>,
                                           значення: памʼять<п8>,
                                           новий_розмір: природне) -> памʼять<п8> {
    перевиділити_памʼять<п8>(значення, новий_розмір);
  }

  дія система_КД_звільнити_сиру_памʼять(система: адреса<КД::Система>,
                                        значення: невідома_памʼять) {
    звільнити_памʼять(значення);
  }

  дія перекодувати_з_ю8(вхід: ю8,
                        екранувати_невідомі: логічне,
                        з_нульовим_байтом_в_кінці: логічне,
                        вихід: адреса<кд>,
                        вихід_місцезнаходжень: адреса<МісцезнаходженняПерекодованого>,
                        вихід_позиції_помилки: адреса<природне>) -> логічне {
    змінна система_КД = КД::Система {
      дані = пусто,
      виділити_сиру_памʼять = система_КД_виділити_сиру_памʼять,
      перевиділити_сиру_памʼять = система_КД_перевиділити_сиру_памʼять,
      звільнити_сиру_памʼять = система_КД_звільнити_сиру_памʼять
    };

    якщо вихід_місцезнаходжень == пусто {
      вернути КД::перекодувати_з_ю8(
        система_КД::адреса,
        вхід,
        екранувати_невідомі,
        з_нульовим_байтом_в_кінці,
        вихід,
        вихід_позиції_помилки
      );
    }

    вернути КД::перекодувати_з_ю8_з_місцезнаходженнями(
      система_КД::адреса,
      вхід,
      екранувати_невідомі,
      з_нульовим_байтом_в_кінці,
      вихід,
      вихід_місцезнаходжень як адреса<КД::Місцезнаходження>,
      вихід_позиції_помилки
    );
  }

  дія перекодувати_в_ю8(вхід: кд,
                        з_нульовим_байтом_в_кінці: логічне,
                        вихід: адреса<ю8>,
                        вихід_місцезнаходжень: адреса<МісцезнаходженняПерекодованого>,
                        вихід_позиції_помилки: адреса<природне>) -> логічне {
    змінна система_КД = КД::Система {
      дані = пусто,
      виділити_сиру_памʼять = система_КД_виділити_сиру_памʼять,
      перевиділити_сиру_памʼять = система_КД_перевиділити_сиру_памʼять,
      звільнити_сиру_памʼять = система_КД_звільнити_сиру_памʼять
    };

    якщо вихід_місцезнаходжень == пусто {
      вернути КД::перекодувати_в_ю8(
        система_КД::адреса,
        вхід,
        з_нульовим_байтом_в_кінці,
        вихід,
        вихід_позиції_помилки
      );
    }

    вернути КД::перекодувати_в_ю8_з_місцезнаходженнями(
      система_КД::адреса,
      вхід,
      з_нульовим_байтом_в_кінці,
      вихід,
      вихід_місцезнаходжень як адреса<КД::Місцезнаходження>,
      вихід_позиції_помилки
    );
  }

  дія перекодувати_ю8_в_ю32(вхід: ю8,
                            з_нульовим_байтом_в_кінці: логічне,
                            вихід: адреса<ю32>,
                            вихід_місцезнаходжень: адреса<МісцезнаходженняПерекодованого>,
                            вихід_позиції_помилки: адреса<природне>) -> логічне {
    змінна система_КД = КД::Система {
      дані = пусто,
      виділити_сиру_памʼять = система_КД_виділити_сиру_памʼять,
      перевиділити_сиру_памʼять = система_КД_перевиділити_сиру_памʼять,
      звільнити_сиру_памʼять = система_КД_звільнити_сиру_памʼять
    };

    вернути КД::перекодувати_ю8_в_ю32(
      система_КД::адреса,
      вхід,
      з_нульовим_байтом_в_кінці,
      вихід,
      вихід_позиції_помилки
    );
  }

  дія перекодувати_ю32_в_ю8(вхід: ю32,
                            з_нульовим_байтом_в_кінці: логічне,
                            вихід: адреса<ю8>,
                            вихід_місцезнаходжень: адреса<МісцезнаходженняПерекодованого>,
                            вихід_позиції_помилки: адреса<природне>) -> логічне {
    змінна система_КД = КД::Система {
      дані = пусто,
      виділити_сиру_памʼять = система_КД_виділити_сиру_памʼять,
      перевиділити_сиру_памʼять = система_КД_перевиділити_сиру_памʼять,
      звільнити_сиру_памʼять = система_КД_звільнити_сиру_памʼять
    };

    вернути КД::перекодувати_ю32_в_ю8(
      система_КД::адреса,
      вхід,
      з_нульовим_байтом_в_кінці,
      вихід,
      вихід_позиції_помилки
    );
  }

  дія обробити_екранізації_в_кд(вхід: кд,
                                з_нульовим_байтом_в_кінці: логічне,
                                вихід: адреса<кд>,
                                вихід_місцезнаходжень: адреса<МісцезнаходженняПерекодованого>,
                                вихід_помилки: невідома_адреса) -> логічне {
    змінна система_КД = КД::Система {
      дані = пусто,
      виділити_сиру_памʼять = система_КД_виділити_сиру_памʼять,
      перевиділити_сиру_памʼять = система_КД_перевиділити_сиру_памʼять,
      звільнити_сиру_памʼять = система_КД_звільнити_сиру_памʼять
    };

    вернути КД::обробити_екранізації_в_кд(
      система_КД::адреса,
      вхід,
      з_нульовим_байтом_в_кінці,
      вихід
    );
  }

  дія обробити_екранізації_в_ю8(вхід: ю8,
                                з_нульовим_байтом_в_кінці: логічне,
                                вихід: адреса<ю8>,
                                вихід_місцезнаходжень: адреса<МісцезнаходженняПерекодованого>,
                                вихід_помилки: невідома_адреса) -> логічне {
    змінна система_КД = КД::Система {
      дані = пусто,
      виділити_сиру_памʼять = система_КД_виділити_сиру_памʼять,
      перевиділити_сиру_памʼять = система_КД_перевиділити_сиру_памʼять,
      звільнити_сиру_памʼять = система_КД_звільнити_сиру_памʼять
    };

    вернути КД::обробити_екранізації_в_ю8(
      система_КД::адреса,
      вхід,
      з_нульовим_байтом_в_кінці,
      вихід
    );
  }

  дія перевірити_чи_кд_рівні(а: кд, б: кд) -> логічне {
    якщо а.розмір != б.розмір {
      вернути ні;
    }

    змінна п: природне = 0;

    поки п < а.розмір {
      якщо а.дані[п] != б.дані[п] {
        вернути ні;
      }

      п += 1;
    }

    вернути так;
  }

  дія перевірити_чи_ю8_рівні(а: ю8, б: ю8) -> логічне {
    якщо а.розмір != б.розмір {
      вернути ні;
    }

    змінна п: природне = 0;

    поки п < а.розмір {
      якщо а.дані[п] != б.дані[п] {
        вернути ні;
      }

      п += 1;
    }

    вернути так;
  }

  дія перевірити_чи_ю8_закінчується_на(значення: ю8, очікуване: ю8) -> логічне {
    якщо значення.розмір < очікуване.розмір {
      вернути ні;
    }

    змінна п: природне = 0;

    поки п < очікуване.розмір {
      якщо значення.дані[(значення.розмір - очікуване.розмір) + п] != очікуване.дані[п] {
        вернути ні;
      }

      п += 1;
    }

    вернути так;
  }

  дія перевірити_чи_текст_закінчується_на(значення: кд, очікуване: кд) -> логічне {
    якщо значення.розмір < очікуване.розмір {
      вернути ні;
    }

    змінна п: природне = 0;

    поки п < очікуване.розмір {
      якщо значення.дані[(значення.розмір - очікуване.розмір) + п] != очікуване.дані[п] {
        вернути ні;
      }

      п += 1;
    }

    вернути так;
  }

  дія обʼєднати_ю8(а: ю8, б: ю8) -> ю8 {
    змінна новий_розмір = а.розмір + б.розмір;
    змінна нові_дані = виділити_памʼять<п8>(новий_розмір);

    змінна пп: природне = 0;
    змінна п: природне = 0;

    поки п < а.розмір {
      нові_дані[пп] = а.дані[п];

      п += 1;
      пп += 1;
    }

    п = 0;

    поки п < б.розмір {
      нові_дані[пп] = б.дані[п];

      п += 1;
      пп += 1;
    }

    вернути ю8 { новий_розмір, нові_дані };
  }

  дія клонувати_ю8(вхід: ю8) -> ю8 {
    змінна нові_дані = виділити_памʼять<п8>(вхід.розмір);

    змінна п: природне = 0;

    поки п < вхід.розмір {
      нові_дані[п] = вхід.дані[п];

      п += 1;
    }

    вернути ю8 { вхід.розмір, нові_дані };
  }
}