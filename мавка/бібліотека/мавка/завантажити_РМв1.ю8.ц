взяти визначення МаМа;
взяти визначення мавка/бібліотека;
взяти визначення мавка/розширення;

зовнішня дія мавка_система_відкрити_поширену_бібліотеку(шлях: ю8): невідома_адреса;
зовнішня дія мавка_система_закрити_поширену_бібліотеку(поширена_бібліотека: невідома_адреса);
зовнішня дія мавка_система_отримати_символ_поширеної_бібліотеки(поширена_бібліотека: невідома_адреса, назва: ю8): невідома_адреса;
зовнішня дія мавка_система_отримати_абсолютний_шлях(шлях: ю8, вихід: адреса<ю8>): логічне;

секція мавка {
  секція бібліотека {
    дія завантажити_РМв1_шлях_ю8(М: адреса<МаМа::Машина>, шлях_ю8: ю8): МаМа::предмет_або_стан_падіння {
      змінна обчислювач = М;
      змінна шлях_до_файлу = ю8 { 0, пусто };
      мавка_система_отримати_абсолютний_шлях(шлях_ю8, шлях_до_файлу::адреса);
      змінна взятий_предмет: адреса<МаМа::Предмет> = пусто;
      якщо МаМа::отримати_взятий_предмет(М, МаМа::створити_предмет_юнікоду_з_ю8(М, шлях_до_файлу) як адреса<МаМа::Предмет>, взятий_предмет::адреса) {
        МаМа::звільнити_памʼять(М, шлях_до_файлу.дані);
        вернути взятий_предмет;
      }
      змінна поширена_бібліотека = мавка_система_відкрити_поширену_бібліотеку(шлях_до_файлу);
      якщо поширена_бібліотека == пусто {
        МаМа::звільнити_памʼять(М, шлях_до_файлу.дані);
        вернути МаМа::результат_стан_падіння(М, МаМа::Місцезнаходження { пусто як адреса<МаМа::ПредметТексту>, 0 }, МаМа::створити_предмет_тексту(М, "Не вдалось відкрити поширену бібліотеку") як адреса<Предмет>);
      }
      змінна символ_завантажити_РМв1 = мавка_система_отримати_символ_поширеної_бібліотеки(поширена_бібліотека, ю8"завантажити_РМв1");
      якщо символ_завантажити_РМв1 == пусто {
        МаМа::звільнити_памʼять(М, шлях_до_файлу.дані);
        мавка_система_закрити_поширену_бібліотеку(поширена_бібліотека);
        вернути МаМа::результат_стан_падіння(М, МаМа::Місцезнаходження { пусто як адреса<МаМа::ПредметТексту>, 0 }, МаМа::створити_предмет_тексту(М, "Не вдалось отримати символ поширеної бібліотеки") як адреса<Предмет>);
      }
      змінна дія_завантаження_РМв1 = символ_завантажити_РМв1 як (Р: адреса<РМв1::Розширення>) -> РМв1::ПредметАбоСтанПадіння;
      змінна результат_РМв1 = розширення::виконати_завантаження_РМв1(обчислювач, дія_завантаження_РМв1);
      якщо перевірити_чи_стан_падіння(обчислювач) == ні {
        МаМа::покласти_взятий_предмет(М, МаМа::створити_предмет_юнікоду_з_ю8(М, шлях_до_файлу) як адреса<МаМа::Предмет>, результат_РМв1 як адреса<МаМа::Предмет>);
      }
      МаМа::звільнити_памʼять(М, шлях_до_файлу.дані);
      вернути результат_РМв1 як адреса<МаМа::Предмет>;
    }

    дія рідна_дія_завантажити_РМв1(М: адреса<МаМа::Машина>, предмет_дії: адреса<МаМа::ПредметДії>, предмет_я: адреса<МаМа::Предмет>, кількість_аргументів: позитивне, аргументи: памʼять<адреса<МаМа::Предмет>>, кількість_іменованих_аргументів: позитивне, іменовані_аргументи: памʼять<МаМа::ІменованийАргумент>, місцезнаходження: МаМа::Місцезнаходження): МаМа::предмет_або_стан_падіння {
      змінна аргумент_шлях: адреса<МаМа::Предмет> = пусто;
      змінна знайдено_аргумент_шлях = ні;
      якщо кількість_іменованих_аргументів > 0 {
        знайдено_аргумент_шлях = МаМа::знайти_іменований_аргумент(М, кількість_іменованих_аргументів, іменовані_аргументи, МаМа::назва(М, "шлях"), аргумент_шлях::адреса);
      }
      якщо кількість_аргументів > 0 {
        якщо знайдено_аргумент_шлях == ні {
          аргумент_шлях = аргументи[0];
          знайдено_аргумент_шлях = так;
        }
      }
      якщо знайдено_аргумент_шлях == ні {
        вернути МаМа::результат_стан_падіння(М, місцезнаходження, МаМа::створити_предмет_тексту(М, "Пропущено аргумент \"шлях\"") як адреса<МаМа::Предмет>);
      }
      змінна шлях_ю8 = ю8 { 0, пусто };
      якщо аргумент_шлях.тип == М.предмет_структури_текст {
        змінна шлях_текст = аргумент_шлях як адреса<МаМа::ПредметТексту>;
        якщо МаМа::перекодувати_т8_в_ю8(М, шлях_текст.значення, шлях_ю8::адреса, ні) == ні {
          вернути МаМа::результат_стан_падіння(М, місцезнаходження, МаМа::створити_предмет_тексту(М, "Не вдалось отримати ю8 з шляху") як адреса<МаМа::Предмет>);
        }
      } інакше якщо аргумент_шлях.тип == М.предмет_структури_юнікод {
        змінна шлях_юнікод = аргумент_шлях як адреса<МаМа::ПредметЮнікоду>;
        якщо МаМа::перекодувати_ю32_в_ю8(М, шлях_юнікод.значення, шлях_ю8::адреса, ні) == ні {
          вернути МаМа::результат_стан_падіння(М, місцезнаходження, МаМа::створити_предмет_тексту(М, "Не вдалось отримати ю8 з шляху") як адреса<МаМа::Предмет>);
        }
      } інакше {
        вернути МаМа::результат_стан_падіння(М, місцезнаходження, МаМа::створити_предмет_тексту(М, "Аргумент \"шлях\" може містити лише текст або юнікод") як адреса<МаМа::Предмет>);
      }
      змінна результат = завантажити_РМв1_шлях_ю8(М, шлях_ю8);
      МаМа::звільнити_памʼять(М, шлях_ю8.дані);
      вернути результат;
    }

    зовнішня дія створити_рідну_дію_бібліотеки_мавка_завантажити_РМв1(обчислювач: адреса<Обчислювач>, предмет_модуля: адреса<Предмет>): предмет_або_стан_падіння {
      змінна М = обчислювач;
      змінна параметр_шлях = МаМа::створити_предмет_параметра(М, МаМа::назва(М, "шлях"), пусто, пусто);
      змінна дані_параметрів_метода_завантажити_РМв1 = виділити_памʼять<адреса<МаМа::ПредметПараметра>>(М, 1);
      дані_параметрів_метода_завантажити_РМв1[0] = параметр_шлях;
      змінна предмет_дії_метода_завантажити_РМв1 = МаМа::створити_предмет_рідної_дії(М, МаМа::назва(М, "завантажити_РМв1"), МаМа::Послідовність<адреса<МаМа::ПредметПараметра>> { 1, дані_параметрів_метода_завантажити_РМв1 }, пусто, рідна_дія_завантажити_РМв1, пусто, пусто, пусто);
      вернути предмет_дії_метода_завантажити_РМв1 як адреса<Предмет>;
    }
  }
}