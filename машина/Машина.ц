/* Машина Мавки */

взяти означення мавка;

простір мавка {
  місцева дія налаштувати_машину(М: адреса<Машина>, налаштування: Налаштування) {
    М.налаштування = налаштування;
    М.значення_дійсне = виділити_дійсне(М);
    М.значення_дійсне.тип = М.значення_дійсне;
    М.значення_дійсність = виділити_дійсне(М);
    М.значення_послідовність = виділити_дійсне(М);
    М.значення_предмет = виділити_дійсне(М);
    
    М.предмет_структури_Структура = створити_структуру(М, пусто, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Структура.тип = М.предмет_структури_Структура;

    М.предмет_структури_Текст = створити_структуру(М, пусто, М.значення_предмет як адреса<ПредметСтруктури>, пусто);

    М.константи_назв = КонстантиНазв {
      _значення = створити_текст(М, "значення"),
      _дійсне = створити_текст(М, "дійсне"),
      _послідовність = створити_текст(М, "послідовність"),
      _дійсність = створити_текст(М, "дійсність"),
      _предмет = створити_текст(М, "предмет"),
      _Структура = створити_текст(М, "Структура"),
      _Модуль = створити_текст(М, "Модуль"),
      _Параметр = створити_текст(М, "Параметр"),
      _Число = створити_текст(М, "Число"),
      _Ціле = створити_текст(М, "Ціле"),
      _Дробове = створити_текст(М, "Дробове"),
      _Текст = створити_текст(М, "Текст"),
      _Код = створити_текст(М, "Код"),
      _Дія = створити_текст(М, "Дія"),
      _Список = створити_текст(М, "Список"),
      _Словник = створити_текст(М, "Словник"),
      _Дані = створити_текст(М, "Дані"),
      _ЗмінніДані = створити_текст(М, "ЗмінніДані"),
      _ДіапазонЦілих = створити_текст(М, "ДіапазонЦілих"),
      _ДіапазонДробових = створити_текст(М, "ДіапазонДробових"),
      _ПеребірДіапазонуЦілих = створити_текст(М, "ПеребірДіапазонуЦілих"),
      _ПеребірДіапазонуДробових = створити_текст(М, "ПеребірДіапазонуДробових"),
      _ПеребірСписку = створити_текст(М, "ПеребірСписку"),
      _далі = створити_текст(М, "далі"),
      _з = створити_текст(М, "з"),
      _чародія_ціле = створити_текст(М, "чародія_ціле"),
      _чародія_текст = створити_текст(М, "чародія_текст"),
      _довжина = створити_текст(М, "довжина"),
      _0 = створити_текст(М, "0"),
      _1 = створити_текст(М, "1"),
      _2 = створити_текст(М, "2"),
      _3 = створити_текст(М, "3"),
      _4 = створити_текст(М, "4"),
      _5 = створити_текст(М, "5"),
      _6 = створити_текст(М, "6"),
      _7 = створити_текст(М, "7"),
      _8 = створити_текст(М, "8"),
      _9 = створити_текст(М, "9"),
      _10 = створити_текст(М, "10"),
      _11 = створити_текст(М, "11"),
      _12 = створити_текст(М, "12"),
      _13 = створити_текст(М, "13"),
      _14 = створити_текст(М, "14"),
      _15 = створити_текст(М, "15"),
      _16 = створити_текст(М, "16"),
      _17 = створити_текст(М, "17"),
      _18 = створити_текст(М, "18"),
      _19 = створити_текст(М, "19"),
      _20 = створити_текст(М, "20"),
      _21 = створити_текст(М, "21"),
      _22 = створити_текст(М, "22"),
      _23 = створити_текст(М, "23"),
      _24 = створити_текст(М, "24"),
      _25 = створити_текст(М, "25"),
      _26 = створити_текст(М, "26"),
      _27 = створити_текст(М, "27"),
      _28 = створити_текст(М, "28"),
      _29 = створити_текст(М, "29"),
      _30 = створити_текст(М, "30"),
      _31 = створити_текст(М, "31"),
      _32 = створити_текст(М, "32"),
      _33 = створити_текст(М, "33"),
      _34 = створити_текст(М, "34"),
      _35 = створити_текст(М, "35"),
      _36 = створити_текст(М, "36"),
      _37 = створити_текст(М, "37"),
      _38 = створити_текст(М, "38"),
      _39 = створити_текст(М, "39"),
      _40 = створити_текст(М, "40"),
      _41 = створити_текст(М, "41"),
      _42 = створити_текст(М, "42"),
      _43 = створити_текст(М, "43"),
      _44 = створити_текст(М, "44"),
      _45 = створити_текст(М, "45"),
      _46 = створити_текст(М, "46"),
      _47 = створити_текст(М, "47"),
      _48 = створити_текст(М, "48"),
      _49 = створити_текст(М, "49"),
      _50 = створити_текст(М, "50"),
      _51 = створити_текст(М, "51"),
      _52 = створити_текст(М, "52"),
      _53 = створити_текст(М, "53"),
      _54 = створити_текст(М, "54"),
      _55 = створити_текст(М, "55"),
      _56 = створити_текст(М, "56"),
      _57 = створити_текст(М, "57"),
      _58 = створити_текст(М, "58"),
      _59 = створити_текст(М, "59"),
      _60 = створити_текст(М, "60"),
      _61 = створити_текст(М, "61"),
      _62 = створити_текст(М, "62"),
      _63 = створити_текст(М, "63"),
    };

    М.предмет_структури_Структура.назва = М.константи_назв._Структура;
    М.предмет_структури_Текст.назва = М.константи_назв._Текст;

    М.предмет_структури_Число = створити_структуру(М, М.константи_назв._Число, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Ціле = створити_структуру(М, М.константи_назв._Ціле, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Дробове = створити_структуру(М, М.константи_назв._Дробове, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Модуль = створити_структуру(М, М.константи_назв._Модуль, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Параметр = створити_структуру(М, М.константи_назв._Параметр, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Код = створити_структуру(М, М.константи_назв._Код, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Дія = створити_структуру(М, М.константи_назв._Дія, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Список = створити_структуру(М, М.константи_назв._Список, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Словник = створити_структуру(М, М.константи_назв._Словник, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_Дані = створити_структуру(М, М.константи_назв._Дані, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_ЗмінніДані = створити_структуру(М, М.константи_назв._ЗмінніДані, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_ДіапазонЦілих = створити_структуру(М, М.константи_назв._ДіапазонЦілих, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_ДіапазонДробових = створити_структуру(М, М.константи_назв._ДіапазонДробових, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_ПеребірДіапазонуЦілих = створити_структуру(М, М.константи_назв._ПеребірДіапазонуЦілих, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_ПеребірДіапазонуДробових = створити_структуру(М, М.константи_назв._ПеребірДіапазонуДробових, М.значення_предмет як адреса<ПредметСтруктури>, пусто);
    М.предмет_структури_ПеребірСписку = створити_структуру(М, М.константи_назв._ПеребірСписку, М.значення_предмет як адреса<ПредметСтруктури>, пусто);

    заповнити_структуру_Текст(М);
    заповнити_структуру_Ціле(М);    
    заповнити_структуру_ПеребірДіапазонуДробових(М);
    заповнити_структуру_ПеребірДіапазонуЦілих(М);
    заповнити_структуру_ПеребірСписку(М);

    М.глобальна_дійсність = створити_дійсність(М, пусто, пусто);

    стала вмісткість_накопичувача_значень = 1024;
    М.накопичувач_значень = НакопичувачЗначень {
      розмір = 0,
      дані = виділити_памʼять<Значення>(М, вмісткість_накопичувача_значень),
      вмісткість = вмісткість_накопичувача_значень
    };

    стала вмісткість_історії_здійснення = 1024;
    М.історія_здійснення = ІсторіяЗдійснення {
      розмір = 0,
      дані = виділити_памʼять<Здійснюване>(М, вмісткість_історії_здійснення),
      вмісткість = вмісткість_історії_здійснення
    };

    М.стан_падіння = ні;
    М.значення_падіння = пусто;
    М.місцезнаходження_падіння = Місцезнаходження { пусто, 0 };

    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._дійсне, М.значення_дійсне);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._послідовність, М.значення_послідовність);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._дійсність, М.значення_дійсність);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._предмет, М.значення_предмет);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Структура, М.предмет_структури_Структура як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Модуль, М.предмет_структури_Модуль як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Параметр, М.предмет_структури_Параметр як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Число, М.предмет_структури_Число як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Ціле, М.предмет_структури_Ціле як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Дробове, М.предмет_структури_Дробове як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Текст, М.предмет_структури_Текст як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Код, М.предмет_структури_Код як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Дія, М.предмет_структури_Дія як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Список, М.предмет_структури_Список як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Словник, М.предмет_структури_Словник як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._Дані, М.предмет_структури_Дані як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._ЗмінніДані, М.предмет_структури_ЗмінніДані як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._ДіапазонЦілих, М.предмет_структури_ДіапазонЦілих як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._ДіапазонДробових, М.предмет_структури_ДіапазонДробових як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._ПеребірДіапазонуЦілих, М.предмет_структури_ПеребірДіапазонуЦілих як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._ПеребірДіапазонуДробових, М.предмет_структури_ПеребірДіапазонуДробових як Значення);
    визначити_в_дійсності(М, М.глобальна_дійсність, М.константи_назв._ПеребірСписку, М.предмет_структури_ПеребірСписку як Значення);
  }

  місцева дія створити_машину(налаштування: Налаштування) -> адреса<Машина> {
    змінна М = налаштування.виділити_сиру_памʼять(пусто, Машина.розмір) як адреса<Машина>;
  
    налаштувати_машину(М, налаштування);
  
    вернути М;
  }

  місцева дія увімкнути_стан_падіння(М: адреса<Машина>, значення_падіння: Значення, місцезнаходження_падіння: Місцезнаходження) -> ніщо {
    М.стан_падіння = так;
    М.значення_падіння = значення_падіння;
    М.місцезнаходження_падіння = місцезнаходження_падіння;
  }

  місцева дія покласти_спробу(М: адреса<Машина>, спроби: адреса<Спроби>, спроба: Спроба) {
    спроби.дані = перевиділити_памʼять<Спроба>(М, спроби.дані, спроби.розмір + 1);
    спроби.дані[спроби.розмір] = спроба;
    спроби.розмір += 1;
  }

  місцева дія видалити_останню_спробу(М: адреса<Машина>, спроби: адреса<Спроби>) {
    якщо спроби.розмір == 0 {
      запанікувати(М, "Немає спроб для видалення.");
      вернути;
    }

    спроби.розмір -= 1;
  }

  місцева дія покласти_в_накопичувач_значень(М: адреса<Машина>, значення: Значення) {
    якщо М.накопичувач_значень.розмір == М.накопичувач_значень.вмісткість {
      запанікувати(М, "Накопичувач значень заповнено!");
      вернути;
    }

    М.накопичувач_значень.дані[М.накопичувач_значень.розмір] = значення;
    М.накопичувач_значень.розмір += 1;
  }

  місцева дія забрати_з_накопичувача_значень(М: адреса<Машина>) -> Значення {
    якщо М.накопичувач_значень.розмір == 0 {
      запанікувати(М, "Накопичувач значень порожній 1!");
    }

    М.накопичувач_значень.розмір -= 1;
    вернути М.накопичувач_значень.дані[М.накопичувач_значень.розмір];
  }

  місцева дія отримати_з_накопичувача_значень(М: адреса<Машина>, позиція: природне) -> Значення {
    якщо М.накопичувач_значень.розмір == 0 {
      запанікувати(М, "Накопичувач значень порожній 2!");
    }

    вернути М.накопичувач_значень.дані[М.накопичувач_значень.розмір - 1 - позиція];
  }

  місцева дія видалити_з_накопичувача_значень(М: адреса<Машина>, кількість: природне) {
    якщо М.накопичувач_значень.розмір == 0 {
      запанікувати(М, "Накопичувач значень порожній 3!");
    }
    
    М.накопичувач_значень.розмір -= кількість;
  }

  місцева дія виконати_взяти(
    М: адреса<Машина>,
    назва_паку: адреса<ПредметТексту>,
    звідки: адреса<ПредметТексту>,
    довжина_шляху: природне,
    шлях: памʼять<адреса<ПредметТексту>>,
    місцезнаходження: Місцезнаходження
  ) -> Значення {    
    якщо М.налаштування.дія_взяття == пусто {
      увімкнути_стан_падіння(
        М,
        створити_текст(М, "Обробник взяття не втілено в Машині") як Значення,
        місцезнаходження
      );
      вернути пусто;
    }

    вернути М.налаштування.дія_взяття(М, назва_паку, звідки, довжина_шляху, шлях);
  }

  місцева дія покласти_в_історію_здійснення(
    М: адреса<Машина>,
    здійснювач: Значення,
    дійсність: адреса<Дійсність>,
    предмет_дії: адреса<ПредметДії>,
    місцезнаходження: Місцезнаходження
  ) {
    М.історія_здійснення.дані[М.історія_здійснення.розмір] = Здійснюване {
      здійснювач = здійснювач,
      дійсність = дійсність,
      предмет_дії = предмет_дії,
      місцезнаходження = місцезнаходження
    };
    М.історія_здійснення.розмір += 1;
  }

  місцева дія видалити_з_історії_здійснення(М: адреса<Машина>, кількість: природне) {
    М.історія_здійснення.розмір -= кількість;
  }
}